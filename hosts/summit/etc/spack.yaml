# OLCF Summit Spack Environment

spack:
  #############################################################################
  definitions:
  - core_compilers:
    - '%gcc@4.8.5'
  - gcc_compilers:
    - '%gcc@4.8.5'
    - '%gcc@5.4.0'
    - '%gcc@6.4.0'
    - '%gcc@7.4.0'
    - '%gcc@8.1.1'
    - '%gcc@9.1.0'
  - xl_compilers:
    - '%xl@16.1.1-4'
    - '%xl@16.1.1-5'
  - llvm_compilers:
    - '%clang@9.0.0-2'
  - pgi_compilers:
    - '%pgi@18.10'
    - '%pgi@19.5'
    - '%pgi@19.7'
  - all_compilers:
    - $gcc_compilers
    - $xl_compilers
    - $llvm_compilers
    - $pgi_compilers
  - core_packages:
    - 'readline'
    - 'git'
    - 'htop'
    - 'tmux'
    - 'cmake'
    - 'cmake@3.11.3'
    - 'python@2.7.15'
    - 'python@3.7.0'
    - 'gnuplot@5.0.1'
    - 'libevent@2.0.21 +openssl'
  - core_only_compute_packages:
    - matrix:
      - - 'py-nose'
        - 'py-numpy'
        - 'py-h5py~mpi'
        - 'py-mpi4py'
      - - '^python@3.7.0'
    - 'darshan-runtime'
    - 'darshan-runtime hdf5=pre1.10'
    - 'darshan-runtime hdf5=post1.10'
    - 'valgrind +mpi+boost'
    - 'adios2 +python ^python@3.7.0'
  - gcc_only_compute_packages:
    - 'amgx +mpi+openmp'
    - 'raja'
    - 'magma'
    - 'nco'
  - general_compute_packages:
    - 'netlib-lapack'
    - 'netlib-scalapack ^netlib-lapack'
    - 'amgx +mpi~openmp'
    - 'fftw +mpi+openmp'
    - 'hdf5 ~mpi'
    - 'hdf5 +mpi'
    - 'hdf5@1.8.18 ~mpi'
    - 'hdf5@1.8.18 +mpi'
    - 'boost ~mpi'
    - 'boost +mpi'
    - 'netcdf'
    - 'netcdf-fortran'
    - 'netcdf-cxx'
    - 'parallel-netcdf'
    - 'parallel-io'
    - 'hypre'
    - 'mpip'
    - 'adios2 ~python'
  - manifest:
    - matrix:
      - - $core_packages
      - - $core_compilers
    - matrix:
      - - 'spectrum-mpi'
      - - $all_compilers
    - matrix:
      - - $core_only_compute_packages
      - - $core_compilers
    - matrix:
      - - 'openblas@0.3.5 threads=openmp cpu_target=POWER8'
        - 'openblas@0.3.5 threads=none cpu_target=POWER8'
      - - '%gcc@4.8.5'
        - '%gcc@5.4.0'
    - matrix:
      - - 'openblas threads=openmp'
        - 'openblas threads=none'
      - - '%gcc@6.4.0'
        - '%gcc@8.1.1'
        - '%gcc@9.1.0'
    - matrix:
      - - 'netlib-scalapack ^openblas@0.3.5 threads=openmp cpu_target=POWER8'
      - - '%gcc@4.8.5'
        - '%gcc@5.4.0'
    - matrix:
      - - 'netlib-scalapack ^openblas threads=openmp'
      - - '%gcc@6.4.0'
        - '%gcc@8.1.1'
        - '%gcc@9.1.0'
    - matrix:
      - - $gcc_only_compute_packages
      - - $gcc_compilers
      # exclude:
      # - raja%gcc@4.8.5
    - matrix:
      - - $general_compute_packages
      - - $all_compilers
      exclude:
        - 'fftw%pgi'
        - 'adios2%pgi'
        - 'mpip%pgi'
    # Compute package exceptions and One-offs
    - matrix:
      - - 'fftw +mpi+openmp simd=skip'
      - - $pgi_compilers
    - 'adios2@2.4.0%pgi ~python ^pkgconf%gcc@4.8.5 ^bzip2%gcc@4.8.5 ^zeromq%gcc@4.8.5 ^zfp%gcc@4.8.5'
    - matrix:
      - - petsc +mpi+mumps~int64~superlu-dist
      - - $gcc_compilers
        - $llvm_compilers
    - matrix:
      - - 'petsc +mpi~mumps~int64~superlu-dist~metis'
      - - $pgi_compilers
  #############################################################################
  specs:
  - $manifest
  #############################################################################
  mirrors: {}
  #############################################################################
  repos:
    - /sw/.testing/belhorn/spack/site-stacks/repos/olcf
  #############################################################################
  packages:
    # General Settings
    all:
      compiler: [gcc@4.8.5, gcc, clang, xl, pgi]
      providers:
        mpi: [spectrum-mpi]
        lapack: [netlib-lapack]
        blas: [netlib-lapack]
        scalapack: [netlib-scalapack]
      buildable: true
      version: []
      target: []
      paths: {}
      modules: {}
    # Site-provided Packages
    cuda:
      buildable: false
      version: [10.1.168]
      modules:
        cuda@10.1.105: cuda/10.1.168
      target: []
      providers: {}
      paths: {}
      compiler: []
    spectrum-mpi:
      buildable: false
      version:
      - 10.3.0.1-20190611
      modules:
        spectrum-mpi@10.3.0.1-20190611: spectrum-mpi/10.3.0.1-20190611
      target: []
      providers: {}
      paths: {}
      compiler: []
    # OS-Provided Packages
    gtkplus:
      version: [2.10.0]
      buildable: false
      paths:
        gtkplus@2.10.0: /usr
      target: []
      providers: {}
      modules: {}
      compiler: []
    openssl:
      buildable: false
      version: [1.0.2]
      paths:
        openssl@1.0.2: /usr
      target: []
      providers: {}
      modules: {}
      compiler: []
    libtool:
      version: [2.4.6, 2.4.2]
      paths:
        libtool@2.4.2: /usr
      buildable: true
      target: []
      providers: {}
      modules: {}
      compiler: []
    # Machine-specific Customizations
    openblas:
      buildable: true
      variants: cpu_target=POWER9
      version: []
      target: []
      providers: {}
      paths: {}
      modules: {}
      compiler: []
    fftw:
      variants: "+float+long_double+openmp+fma simd=vsx"
    papi:
      variants: "cpu=POWER9"
    magma:
      variants: "gpus=volta"
    netlib-scalapack:
      variants: "+fpic"
    netcdf:
      variants: "~hdf4+mpi+parallel-netcdf+shared"
    parallel-netcdf:
      variants: "+cxx+fortran+fpic"
    darshan-runtime:
      variants: "+lsf+grouplogs logpath=/gpfs/alpine/darshan/summit"
    # PGI Exceptions
    cmake:
      variants: +ownlibs
      buildable: true
      modules:
        cmake@3.14.2%pgi: cmake/3.14.2
    python:
      version: [3.7.0, 2.7.15]
      modules:
        python@3.7.0%pgi: python/3.7.0
        python@2.7.15%pgi: python/2.7.15
  #############################################################################
  view: false
  #############################################################################
  modules:
    enable:
    - lmod
    lmod:
      core_compilers: [gcc@4.8.5]
      all:
        suffixes:
          ^python@2.0:2.99: py2
          ^python@3.0:3.99: py3
        environment:
          set:
            OLCF_${PACKAGE}_ROOT: ${PREFIX}
      pgi:
        filter:
          # Exclude changes to any of these variables
          environment_blacklist: [CPATH, LIBRARY_PATH]
      spectrum-mpi:
        environment:
          set:
            PAMI_IBV_ENABLE_OOO_AR: '1'
            PAMI_IBV_QP_SERVICE_LEVEL: '8'
      pcre:
        suffixes:
          pcre+jit: jit
      amgx:
        suffixes:
          amgx~openmp: unthreaded
      spectral:
        template: olcf/modules/spectral.lua
      darshan-runtime:
        suffixes:
          hdf5=pre1.10: hdf5pre110
          hdf5=post1.10: hdf5post110
      blacklist_implicits: true
      verbose: true
  #############################################################################
  config:
    install_tree: /gpfs/alpine/stf007/scratch/belhorn/spack/stacks/summit/production/opt
    module_roots:
      tcl: /gpfs/alpine/stf007/scratch/belhorn/spack/stacks/summit/production/modules/tmod
      lmod: /gpfs/alpine/stf007/scratch/belhorn/spack/stacks/summit/production/modules/lmod
    misc_cache: /sw/.testing/belhorn/spack/site-stacks/var/summit/mcache
    source_cache: /sw/.testing/belhorn/spack/site-stacks/var/summit/cache
    build_jobs: 6
    verify_ssl: true
    checksum: true
    dirty: false
  #############################################################################
  upstreams:
    summit-compute:
      install_tree: /sw/summit/.swci/1-compute/opt/spack/20180914
  #############################################################################
  concretization: separately
