# OLCF Spock Spack Environment

spack:
  #############################################################################
  definitions:
  - core_compiler:
    - '%gcc@7.5.0'
  - gcc_compilers:
    - '%gcc@10.2.0'
    - '%gcc@9.3.0'
    - '%gcc@8.1.0'
  # - cray_compilers:
  #   - '%cce@11.0.0.7519'
  - all_compilers:
    - $gcc_compilers
    # - $cray_compilers
  - core_packages:
    - git
    - htop
    - tmux
    - cmake
    - wget
    - go
    - screen
    - vim
    - emacs ~X
    - nano
    - gnuplot +X
    - subversion
    - mercurial
    - ccache
    - papi
    - gdb
    - libzmq
    - gnupg
    - python
    # - valgrind ~mpi~boost~ubsan
    # - gsl
    # - nco~mpi-deps
    # - libfabric fabrics=verbs
    # - imagemagick ^ncurses+termlib
    # - r
    # - r@4.0.0
    # - ferret ^hdf5~mpi+cxx+fortran ^netcdf-c~mpi~parallel-netcdf ^netcdf-fortran~mpi
    # - cdo+hdf5+netcdf ^hdf5~mpi+cxx+fortran ^fftw~mpi+openmp ^netcdf-c~mpi~parallel-netcdf
    # - vmd
    # - sbt
    # - spark+hadoop
  - rocm_packages:
    ## Base packages
    - hip
    - hip-rocclr
    - comgr
    - rocm-cmake
    - llvm-amdgpu
    - rocm-device-libs
    - hsa-rocr-dev
    - hsakmt-roct
    - rocminfo
    - rccl
    - hipify-clang
    ## hip libraries
    - hipblas
    - hipcub
    - hipsparse
    - hipfort
    - hipfft ## missing spackage?
    # - hiprand ## missing spackage?
    ## rocm libraries
    - rocm-opencl
    - rocm-clang-ocl
    - rocm-opencl-runtime
    - rocm-openmp-extras
    - rocblas
    - rocfft
    - rocrand
    - rocthrust
    - rocsolver
    - rocsparse
    # - roctracer-dev ## python2 dependency error
    - rocprofiler-dev
    - rocprim
    - rocm-smi
    - rocm-smi-lib
    - miopen-hip
    ## Utils
    - rocalution
    - rocm-gdb
  - general_compute_packages:
    - netlib-lapack
    - netlib-scalapack ^netlib-lapack
    - fftw +mpi+openmp
    - hdf5 ~mpi
    - hdf5 +mpi
  - core_specs:
    - matrix:
      - - $core_packages
      - - $core_compiler
      - - arch=linux-sles15-x86_64
  - rocm_specs:
    - matrix:
      - - $rocm_packages
      - - '@4.1.0'
        - '@4.0.0'
      - - $core_compiler
      - - arch=linux-sles15-x86_64
      exclude:
      ## 2021-04-07 Not yet in spack vvvvvv
      # - rccl@4.1.0 
      # - hipblas@4.1.0
      # - hipcub@4.1.0
      # - hipsparse@4.1.0
      # - rocrand@4.1.0
      # - rocthrust@4.1.0
      # - rocsolver@4.1.0
      # - rocsparse@4.1.0
      - rocprofiler-dev@4.1.0
      # - rocprim@4.1.0
      # - rocalution@4.1.0
      ## ^^^^^^^^^^^^
      # - rocblas@4.1.0    ## 2021-04-07 build errors
      # - rocfft@4.1.0     ## 2021-04-07 build errors
      - rocm-smi@4.1.0   ## Replaced with rocm-smi-lib
      # - miopen-hip@4.1.0 ## 2021-04-07 build errors
      - hipfft@4.0.0
  specs:
  - $core_specs
  - $rocm_specs
  # - $cray_specs
  #############################################################################
  mirrors:
    facility_builds: /sw/spock/spack-env/mirrors/builds
  repos:
  - ${FACSPACK_CONF_COMMON}/spack/repos/olcf
  #############################################################################
  packages:
    openmpi:
      buildable: false
      version: []
      target: []
      compiler: []
      providers: {}
    mvapich2:
      version: [2.3.4]
      externals:
      - spec: mvapich2@2.3.4
        modules:
        - cray-mvapich2_nogpu/2.3.4
      target: []
      compiler: []
      buildable: true
      providers: {}
    qt:
      variants: ~ssl
      buildable: true
      version: []
      target: []
      providers: {}
      compiler: []
    ncurses:
      variants: +termlib
      buildable: true
      version: []
      target: []
      providers: {}
      compiler: []
    slurm:
      buildable: false
      version: [20.11.3]
      target: []
      compiler: []
      providers: {}
      externals:
      - spec: slurm@20.11.3
        prefix: /usr
    m4:
      buildable: true
      version: [1.4.18]
      target: []
      providers: {}
      externals: []
      compiler: []
    binutils:
      buildable: true
      target: []
      providers: {}
      compiler: []
      variants: +libiberty
      version: []
    openssl:
      buildable: false
      version: [1.1.1]
      target: []
      providers: {}
      externals:
      - spec: openssl@1.1.1
        prefix: /usr
      compiler: []
    octave:
      variants: +magick+arpack+curl+fftw+fontconfig+freetype+glpk+gnuplot+hdf5+opengl+qhull+qrupdate+qt+readline+suitesparse+zlib
      buildable: true
      version: []
      target: []
      providers: {}
      compiler: []
    libtool:
      buildable: true
      version: [2.4.6]
      target: []
      providers: {}
      compiler: []
    r:
      variants: ~X
      buildable: true
      version: []
      target: []
      providers: {}
      compiler: []
    fftw:
      variants: precision=float,double,long_double
      buildable: true
      version: []
      target: []
      providers: {}
      compiler: []
    hdf5:
      variants: +hl+cxx+fortran
      buildable: true
      version: []
      target: []
      providers: {}
      compiler: []
    netlib-scalapack:
      variants: +fpic
      buildable: true
      version: []
      target: []
      providers: {}
      compiler: []
    netcdf-c:
      variants: ~hdf4+mpi+parallel-netcdf+shared
      buildable: true
      version: []
      target: []
      providers: {}
      compiler: []
    parallel-netcdf:
      variants: +cxx+fortran+fpic
      buildable: true
      version: []
      target: []
      providers: {}
      compiler: []
    rocfft:
      variants: amdgpu_target=gfx908 amdgpu_target_sram_ecc=gfx908
    all:
      buildable: true
      version: []
      target: [x86_64]
      providers:
        mpi: [mvapich2]
        lapack: [openblas, mkl]
        blas: [openblas, mlk]
        scalapack: [netlib-scalapack]
      compiler: [gcc@7.5.0, gcc]
  # Views are managed externally; placing them here triggers a regneration each
  # time the env is re-concretized which both destroys non-spack files (eg
  # symlinks) in "hybrid views" and removes previous builds slated to be
  # re-built from the production view when we want to minimize disruption to
  # users. See $FACSPACK_CONF_ENV/view-generate-*.sh scripts for managing views.
  view: false
  modules:
    enable:
    - lmod
    - tcl
    lmod:
      core_compilers: [gcc@7.5.0]
      all:
        environment:
          set:
            OLCF_${PACKAGE}_ROOT: ${PREFIX}
          unset: []
        filter:
          environment_blacklist: []
        load: []
        conflict: []
      openmpi:
        filter:
          environment_blacklist: []
        conflict: []
        load: []
        environment:
          unset: []
      openblas:
        suffixes:
          openblas threads=openmp: omp
          openblas threads=pthreads: pthreads
        filter:
          environment_blacklist: []
        conflict: []
        load: []
        environment:
          unset: []
      fftw:
        suffixes:
          fftw+openmp: omp
        filter:
          environment_blacklist: []
        conflict: []
        load: []
        environment:
          unset: []
      hdf5:
        suffixes:
          hdf5~mpi+szip: sz
          hdf5~mpi+threadsafe: threadsafe
        filter:
          environment_blacklist: []
        conflict: []
        load: []
        environment:
          unset: []
      cdo:
        suffixes:
          cdo^hdf5+mpi^netcdf+mpi^fftw+mpi: parallel
        filter:
          environment_blacklist: []
        conflict: []
        load: []
        environment:
          unset: []
      cairo:
        suffixes:
          cairo+X: X
          cairo+pdf: pdf
        filter:
          environment_blacklist: []
        conflict: []
        load: []
        environment:
          unset: []
      gromacs:
        suffixes:
          gromacs~rdtscp: rdtscp_off
          gromacs~mpi: analysis
        filter:
          environment_blacklist: []
        conflict: []
        load: []
        environment:
          unset: []
      vtk:
        suffixes:
          vtk+mpi: parallel
          vtk~mpi: serial
          vtk+qt: qt
        filter:
          environment_blacklist: []
        conflict: []
        load: []
        environment:
          unset: []
      ferret:
        suffixes:
          ferret^hdf5+mpi^netcdf+mpi: parallel
        filter:
          environment_blacklist: []
        conflict: []
        load: []
        environment:
          unset: []
      ncl:
        suffixes:
          builtin.ncl ^hdf5+mpi^netcdf+mpi: parallel
          olcf.ncl: serial
        filter:
          environment_blacklist: []
        conflict: []
        load: []
        environment:
          unset: []
      pango:
        suffixes:
          pango+X: X
        filter:
          environment_blacklist: []
        conflict: []
        load: []
        environment:
          unset: []
      blacklist_implicits: false
      verbose: true
      whitelist: []
      blacklist:
      - python
      - go-bootstrap
      - meson
      - py-setuptools
      - glib
      - openssl
      - harfbuzz ^cairo~X
      - pango ^cairo~pdf
      - '%gcc@7-os'
      hash_length: 0
      hierarchy: []
      projections: {}
      core_specs: []
    tcl:
      hash_length: 3
      naming_scheme: '{name}/{version}-{compiler.name}-{compiler.version}'
      blacklist:
      - slurm
      - go-bootstrap
      - openssl
      all:
        conflict:
        - '{name}'
        environment:
          set:
            OLCF_${PACKAGE}_ROOT: ${PREFIX}
          unset: []
        filter:
          environment_blacklist: []
        load: []
      verbose: false
      whitelist: []
      blacklist_implicits: false
      projections: {}
  config:
    install_tree:
      root: ${FACSPACK_ENV}/opt
      projections:
        all: ${ARCHITECTURE}/${COMPILERNAME}-${COMPILERVER}/${PACKAGE}-${VERSION}-${HASH}
    module_roots:
      tcl: ${FACSPACK_ENV_MODULEROOT}/flat
      lmod: ${FACSPACK_ENV_MODULEROOT}/spack
    template_dirs:
    - ${FACSPACK_CONF_HOST}/templates
    - ${FACSPACK_CONF_COMMON}/spack/templates
    - $spack/share/spack/templates
    build_stage:
    - $tempdir/$user/spack-stage
    - $spack/var/spack/stage
    source_cache: ${FACSPACK_CONF_COMMON}/mirrors/sources
    extensions:
    - /sw/sources/facspack/share/spack/extensions/spack-olcf
    misc_cache: ${FACSPACK_ENV}/.mcache
    verify_ssl: true
    install_missing_compilers: false
    checksum: true
    dirty: false
    build_language: C
    build_jobs: 8
    ccache: false
    db_lock_timeout: 120
    package_lock_timeout:
    shared_linking: rpath
    allow_sgid: true
    concretizer: original
    locks: true
    suppress_gpg_warnings: false
    connect_timeout: 10
    test_stage: ~/.spack/test
  concretization: separately
  compilers:
  - compiler:
      spec: gcc@7.5.0
      paths:
        cc: /usr/bin/gcc
        cxx: /usr/bin/g++
        f77: /usr/bin/gfortran
        fc: /usr/bin/gfortran
      flags: {}
      operating_system: sles15
      target: any
      modules: []
      environment:
        unset: []
      extra_rpaths: []
  - compiler:
      spec: gcc@7-os
      paths:
        cc: /usr/bin/gcc
        cxx: /usr/bin/g++
        f77: /usr/bin/gfortran
        fc: /usr/bin/gfortran
      flags: {}
      operating_system: sles15
      target: any
      modules: []
      environment:
        append_path:
          PKG_CONFIG_PATH: /usr/lib64/pkgconfig
        unset: []
      extra_rpaths: []
  - compiler:
      spec: gcc@10.2.0
      paths:
        cc: /opt/gcc/10.2.0/snos/bin/gcc
        cxx: /opt/gcc/10.2.0/snos/bin/g++
        f77: /opt/gcc/10.2.0/snos/bin/gfortran
        fc: /opt/gcc/10.2.0/snos/bin/gfortran
      flags: {}
      operating_system: sles15
      target: any
      modules: []
      environment: {}
      extra_rpaths:
      - /opt/gcc/10.2.0/snos/lib64
  - compiler:
      spec: gcc@9.3.0
      paths:
        cc: /opt/gcc/9.3.0/snos/bin/gcc
        cxx: /opt/gcc/9.3.0/snos/bin/g++
        f77: /opt/gcc/9.3.0/snos/bin/gfortran
        fc: /opt/gcc/9.3.0/snos/bin/gfortran
      flags: {}
      operating_system: sles15
      target: any
      modules: []
      environment: {}
      extra_rpaths:
      - /opt/gcc/9.3.0/snos/lib64
  - compiler:
      spec: gcc@8.1.0
      paths:
        cc: /opt/gcc/8.1.0/snos/bin/gcc
        cxx: /opt/gcc/8.1.0/snos/bin/g++
        f77: /opt/gcc/8.1.0/snos/bin/gfortran
        fc: /opt/gcc/8.1.0/snos/bin/gfortran
      flags: {}
      operating_system: sles15
      target: any
      modules: []
      environment: {}
      extra_rpaths:
      - /opt/gcc/8.1.0/snos/lib64
  - compiler:
      spec: cce@11.0.4
      paths:
        cc: cc
        cxx: CC
        f77: ftn
        fc: ftn
      flags: {}
      operating_system: sles15
      target: any
      modules:
      - craype-accel-amd-gfx908                ## Base performance option
      # - cce/11.0.4                           ## Default auto-loaded by PrgEnv-Cray
      ## - rocm/3.7.0                          ## Not on Spock yet (2021-04-06)
      # - craype/2.7.6                         ## handled by PrgEnv-Cray
      # - craype-x86-rome                      ## handled by PrgEnv-Cray
      # - libfabric/1.11.0.3.71                ## handled by PrgEnv-Cray
      # - craype-network-ofi                   ## handled by PrgEnv-Cray
      # - cray-dsmml/0.1.4                     ## handled by PrgEnv-Cray
      # - perftools-base/21.02.0               ## handled by PrgEnv-Cray
      # - xpmem/2.2.40-2.1_2.7_g3cf3325.shasta ## handled by PrgEnv-Cray
      # - cray-mpich/8.1.4                     ## handled by PrgEnv-Cray
      # - cray-libsci/21.04.1.1                ## handled by PrgEnv-Cray
      # - cray-pmi/6.0.10                      ## handled by PrgEnv-Cray
      # - cray-pmi-lib/6.0.10                  ## handled by PrgEnv-Cray
      - PrgEnv-cray ## /8.0.0 ?
      - cce/11.0.4                             ## Override PrgEnv default
      environment: {}
      extra_rpaths: []
